<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SimulationFIN31.ViewModels"
             mc:Ignorable="d" d:DesignWidth="1400" d:DesignHeight="800"
             x:Class="SimulationFIN31.Views.SimulationView"
             x:DataType="vm:SimulationViewModel"
             x:Name="TreeHost">

    <Grid Background="{StaticResource Brush.BackdropGradient}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Compact Header -->
        <Border Grid.Row="0" Classes="CompactHeader" Margin="0,0,0,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <Button Grid.Column="0"
                        Content="Zurück"
                        Classes="Glass"
                        Command="{Binding GoBackCommand}"
                        Width="100"
                        Height="36" />

                <StackPanel Grid.Column="1"
                            HorizontalAlignment="Center"
                            Orientation="Horizontal"
                            Spacing="16">
                    <TextBlock Text="Alter:"
                               Classes="Label"
                               VerticalAlignment="Center"
                               Margin="0" />
                    <TextBlock Text="{Binding CurrentAge}"
                               Classes="Value"
                               FontSize="20"
                               VerticalAlignment="Center" />
                    <TextBlock Text="|"
                               Foreground="{DynamicResource TextSecondaryBrush}"
                               VerticalAlignment="Center" />
                    <TextBlock Text="{Binding CurrentLifePhase}"
                               Classes="Value"
                               FontSize="16"
                               VerticalAlignment="Center" />
                </StackPanel>

                <!-- Simulation Status Indicator -->
                <StackPanel Grid.Column="2"
                            Orientation="Horizontal"
                            Spacing="6"
                            VerticalAlignment="Center">
                    <Ellipse Width="10" Height="10"
                             Fill="#2ECC71"
                             IsVisible="{Binding IsRunning}" />
                    <Ellipse Width="10" Height="10"
                             Fill="#F39C12"
                             IsVisible="{Binding IsPaused}" />
                    <TextBlock Text="Laufend"
                               IsVisible="{Binding IsRunning}"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                    <TextBlock Text="Pausiert"
                               IsVisible="{Binding IsPaused}"
                               FontSize="12"
                               Foreground="{DynamicResource TextSecondaryBrush}" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Content Area - 3 Column Layout -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="280" />
            </Grid.ColumnDefinitions>

            <!-- LEFT PANEL: Stats and Controls -->
            <StackPanel Grid.Column="0" Spacing="16">

                <!-- Mental Health Stats Panel -->
                <Border Classes="GlassPanel">
                    <StackPanel Spacing="14">
                        <TextBlock Text="Psychische Gesundheit"
                                   Classes="SectionHeader"
                                   Margin="0,0,0,4" />

                        <!-- Stress Level -->
                        <StackPanel Spacing="4">
                            <Grid>
                                <TextBlock Text="Stress" Classes="Label" Margin="0" />
                                <TextBlock Text="{Binding StressLevel, StringFormat={}{0:F0}%}"
                                           Classes="Value" />
                            </Grid>
                            <ProgressBar Classes="StressBar"
                                         Minimum="0"
                                         Maximum="100"
                                         Value="{Binding StressLevel}" />
                        </StackPanel>

                        <!-- Mood Level -->
                        <StackPanel Spacing="4">
                            <Grid>
                                <TextBlock Text="Stimmung" Classes="Label" Margin="0" />
                                <TextBlock Text="{Binding MoodLevel, StringFormat={}{0:F0}}"
                                           Classes="Value" />
                            </Grid>
                            <ProgressBar Classes="MoodBar"
                                         Minimum="-100"
                                         Maximum="100"
                                         Value="{Binding MoodLevel}" />
                        </StackPanel>

                        <!-- Social Level -->
                        <StackPanel Spacing="4">
                            <Grid>
                                <TextBlock Text="Soziale Zugehörigkeit" Classes="Label" Margin="0" />
                                <TextBlock Text="{Binding SocialLevel, StringFormat={}{0:F0}%}"
                                           Classes="Value" />
                            </Grid>
                            <ProgressBar Classes="SocialBar"
                                         Minimum="0"
                                         Maximum="100"
                                         Value="{Binding SocialLevel}" />
                        </StackPanel>
                    </StackPanel>
                </Border>

                <!-- Simulation Speed Panel -->
                <Border Classes="GlassPanel">
                    <StackPanel Spacing="10">
                        <Grid>
                            <TextBlock Text="Geschwindigkeit" Classes="Label" Margin="0" />
                            <TextBlock Text="{Binding SimulationSpeed, StringFormat={}{0:F2}x}"
                                       Classes="Value" />
                        </Grid>

                        <Slider Minimum="0.25"
                                Maximum="5"
                                Value="{Binding SimulationSpeed}"
                                TickFrequency="0.25"
                                IsSnapToTickEnabled="True" />
                    </StackPanel>
                </Border>

                <!-- Control Buttons Panel -->
                <Border Classes="GlassPanel">
                    <StackPanel Spacing="10">
                        <TextBlock Text="Steuerung"
                                   Classes="SectionHeader"
                                   Margin="0,0,0,4" />

                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <Button Grid.Column="0" Grid.Row="0"
                                    Content="Start"
                                    Classes="Accent"
                                    Command="{Binding StartSimulationCommand}"
                                    Margin="0,0,4,6"
                                    Height="40" />

                            <Button Grid.Column="1" Grid.Row="0"
                                    Content="Pause"
                                    Classes="Glass"
                                    Command="{Binding PauseSimulationCommand}"
                                    Margin="4,0,0,6"
                                    Height="40" />

                            <Button Grid.Column="0" Grid.Row="1"
                                    Content="Stop"
                                    Classes="Glass"
                                    Command="{Binding StopSimulationCommand}"
                                    Margin="0,0,4,0"
                                    Height="40" />

                            <Button Grid.Column="1" Grid.Row="1"
                                    Content="Reset"
                                    Classes="Glass"
                                    Command="{Binding ResetSimulationCommand}"
                                    Margin="4,0,0,0"
                                    Height="40" />
                        </Grid>
                    </StackPanel>
                </Border>
            </StackPanel>

            <!-- CENTER PANEL: Illnesses, Events, Tree -->
            <Grid Grid.Column="1" Margin="16,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!-- Top Row: Illnesses Panel -->
                <Border Grid.Row="0" Classes="IllnessPanel" Margin="0,0,0,12">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="Erkrankungen:"
                                   FontSize="13"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center" />
                        <ItemsControl ItemsSource="{Binding ActiveIllnessNames}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="8" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="#20E74C3C"
                                            CornerRadius="6"
                                            Padding="8,4">
                                        <TextBlock Text="{Binding}"
                                                   Classes="IllnessName" />
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        <TextBlock Text="Keine"
                                   FontSize="13"
                                   FontStyle="Italic"
                                   Foreground="{DynamicResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding !ActiveIllnessNames.Count}" />
                    </StackPanel>
                </Border>

                <!-- Tree Animation Area with Event Icons Around It -->
                <Border Grid.Row="1" Classes="TreeContainer">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!-- Coping Event - Top Center (above tree) -->
                        <StackPanel Grid.Column="1" Grid.Row="0"
                                    HorizontalAlignment="Center"
                                    VerticalAlignment="Bottom"
                                    Margin="0,8,0,0">
                            <Border Classes="EventIconBox"
                                    ToolTip.Tip="{Binding LatestCopingEvent.TooltipText}"
                                    IsVisible="{Binding LatestCopingEvent, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <Image Source="{Binding LatestCopingEvent.Icon}"
                                       Stretch="Uniform" />
                            </Border>
                            <Border Classes="EventIconBox"
                                    IsVisible="{Binding LatestCopingEvent, Converter={x:Static ObjectConverters.IsNull}}"
                                    Opacity="0.3">
                                <TextBlock Text="C"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           FontSize="40"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                            </Border>
                        </StackPanel>

                        <!-- Personal Events - Left Side (Stack) -->
                        <StackPanel Grid.Column="0" Grid.Row="1"
                                    HorizontalAlignment="Right"
                                    VerticalAlignment="Center"
                                    Margin="8,0,0,0"
                                    Spacing="12">
                            <Border Classes="EventIconBox"
                                    ToolTip.Tip="{Binding LatestPersonalEvent.TooltipText}"
                                    IsVisible="{Binding LatestPersonalEvent, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <Image Source="{Binding LatestPersonalEvent.Icon}"
                                       Stretch="Uniform" />
                            </Border>
                            <Border Classes="EventIconBox"
                                    IsVisible="{Binding LatestPersonalEvent, Converter={x:Static ObjectConverters.IsNull}}"
                                    Opacity="0.3">
                                <TextBlock Text="P1"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           FontSize="32"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                            </Border>
                        </StackPanel>

                        <!-- Avatar Animation - Center -->
                        <TransitioningContentControl Grid.Column="1" Grid.Row="1"
                                                     Content="{Binding CurrentLifePhaseKey}"
                                                     VerticalAlignment="Bottom"
                                                     HorizontalAlignment="Center"
                                                     VerticalContentAlignment="Bottom"
                                                     HorizontalContentAlignment="Center">
                            <TransitioningContentControl.PageTransition>
                                <CrossFade Duration="0:0:0.9" />
                            </TransitioningContentControl.PageTransition>
                            <TransitioningContentControl.ContentTemplate>
                                <DataTemplate>
                                    <Image
                                        Source="{Binding #TreeHost.((vm:SimulationViewModel)DataContext).CurrentTreeImage}"
                                        MaxHeight="450"
                                        Stretch="Uniform" />
                                </DataTemplate>
                            </TransitioningContentControl.ContentTemplate>
                        </TransitioningContentControl>
                        <StackPanel Grid.Column="2" Grid.Row="1"
                                    HorizontalAlignment="Left"
                                    VerticalAlignment="Center"
                                    Margin="0,0,8,0"
                                    Spacing="12">
                            
                            <Border Classes="EventIconBox"
                                    ToolTip.Tip="{Binding LatestGenericEvent.TooltipText}"
                                    IsVisible="{Binding LatestGenericEvent, Converter={x:Static ObjectConverters.IsNotNull}}">
                                <Image Source="{Binding LatestGenericEvent.Icon}"
                                       Stretch="Uniform" />
                            </Border>
                            <Border Classes="EventIconBox"
                                    IsVisible="{Binding LatestGenericEvent, Converter={x:Static ObjectConverters.IsNull}}"
                                    Opacity="0.3">
                                <TextBlock Text="G1"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"
                                           FontSize="32"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource TextSecondaryBrush}" />
                            </Border>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <!-- RIGHT PANEL: Event Log -->
            <Border Grid.Column="2"
                    Classes="GlassPanel">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top"
                               Text="Ereignisprotokoll"
                               Classes="SectionHeader" />

                    <ListBox ItemsSource="{Binding EventLog}"
                             Background="Transparent"
                             BorderThickness="0">
                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="vm:EventLogEntry">
                                <StackPanel Spacing="2">
                                    <TextBlock Text="{Binding DisplayText}"
                                               FontWeight="SemiBold"
                                               FontSize="13"
                                               Foreground="{DynamicResource TextPrimaryBrush}" />
                                    <TextBlock Text="{Binding Description}"
                                               TextWrapping="Wrap"
                                               Foreground="{DynamicResource TextSecondaryBrush}"
                                               FontSize="11" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>